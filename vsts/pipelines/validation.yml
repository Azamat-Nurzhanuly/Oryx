parameters:
  - name: buildImages
    type: object
    default:
      - 
        key: latest
        value: ltsversions
      - 
        key: jamstack
        value: jamstack
      - 
        key: githubActions
        value: githubactions
      - 
        key: vsoFocal
        value: vso-focal
      - 
        key: full
        value: full
      - 
        key: cli
        value: cli
      - 
        key: buildpack
        value: buildpack

resources:
- repo: self
  fetchDepth: 15

variables:
  group: Oryx
  Packaging.EnableSBOMSigning: true

jobs:
- job: Job_Security
  displayName: Security
  pool:
    name: Azure Pipelines
    vmImage: windows-2022
  steps:
  - template: templates/_securityChecks.yml

- ${{ each buildImage in parameters.buildImages }}:
  - job: Job_BuildImage_${{ buildImage.key }}
    displayName: 'Build & Test ${{ buildImage.key }} build image'
    pool:
      name: AzurePipelines-EO
      demands:
        - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
      timeoutInMinutes: 480
      steps:
      - script: |
          echo "##vso[task.setvariable variable=BuildBuildImages;]true"
          echo "##vso[task.setvariable variable=TestBuildImages;]true"
          echo "##vso[task.setvariable variable=PushBuildImages;]false"
          echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
          echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
          echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
        displayName: 'Set variables'
      - template: templates/_buildTemplate.yml
        parameters:
            imageType: ${{ buildImage.value }}

#- job: Job_BuildImage_ltsVersions
#  displayName: Build and Test Build LtsVersions Image
#  pool:
#    name: AzurePipelines-EO
#    demands:
#      - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
#  timeoutInMinutes: 480
#  steps:
#  - script: |
#      echo "##vso[task.setvariable variable=BuildBuildImages;]true"
#      echo "##vso[task.setvariable variable=TestBuildImages;]true"
#      echo "##vso[task.setvariable variable=PushBuildImages;]false"
#      echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
#      echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
#      echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
#    displayName: 'Set variables'
#  - template: templates/_buildTemplate.yml
#    parameters:
#        imageType: ltsversions

#- job: Job_BuildImage_Jamstack
#  displayName: Build and Test Build Jamstack Image
#  pool:
#    name: AzurePipelines-EO
#    demands:
#      - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
#  timeoutInMinutes: 480
#  steps:
#  - script: |
#      echo "##vso[task.setvariable variable=BuildBuildImages;]true"
#      echo "##vso[task.setvariable variable=TestBuildImages;]true"
#      echo "##vso[task.setvariable variable=PushBuildImages;]false"
#      echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
#      echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
#      echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
#    displayName: 'Set variables'
#  - template: templates/_buildTemplate.yml
#    parameters:
#        imageType: jamstack

#- job: Job_BuildImage_latest
#  displayName: Build and Test Build Latest Image
#  pool:
#    name: AzurePipelines-EO
#    demands:
#      - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
#  timeoutInMinutes: 480
#  steps:
#  - script: |
#      echo "##vso[task.setvariable variable=BuildBuildImages;]true"
#      echo "##vso[task.setvariable variable=TestBuildImages;]true"
#      echo "##vso[task.setvariable variable=PushBuildImages;]false"
#      echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
#      echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
#      echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
#    displayName: 'Set variables'
#  - template: templates/_buildTemplate.yml
#    parameters:
#        imageType: latest

#- job: Job_BuildImage_GithubActions
#  displayName: Build and Test Build GithubActions Image
#  pool:
#    name: AzurePipelines-EO
#    demands:
#      - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
#  timeoutInMinutes: 480
#  steps:
#  - script: |
#      echo "##vso[task.setvariable variable=BuildBuildImages;]true"
#      echo "##vso[task.setvariable variable=TestBuildImages;]true"
#      echo "##vso[task.setvariable variable=PushBuildImages;]false"
#      echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
#      echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
#      echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
#    displayName: 'Set variables'
#  - template: templates/_buildTemplate.yml
#    parameters:
#        imageType: githubactions

#- job: Job_BuildImage_VsoFocal
#  displayName: Build and Test Build Vso-focal Image
#  pool:
#    name: AzurePipelines-EO
#    demands:
#      - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
#  timeoutInMinutes: 480
#  steps:
#  - script: |
#      echo "##vso[task.setvariable variable=BuildBuildImages;]true"
#      echo "##vso[task.setvariable variable=TestBuildImages;]true"
#      echo "##vso[task.setvariable variable=PushBuildImages;]false"
#      echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
#      echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
#      echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
#    displayName: 'Set variables'
#  - template: templates/_buildTemplate.yml
#    parameters:
#        imageType: vso-focal

#- job: Job_BuildImage_Full
#  displayName: Build and Test Build Full Image
#  pool:
#    name: AzurePipelines-EO
#    demands:
#      - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
#  timeoutInMinutes: 480
#  steps:
#  - script: |
#      echo "##vso[task.setvariable variable=BuildBuildImages;]true"
#      echo "##vso[task.setvariable variable=TestBuildImages;]true"
#      echo "##vso[task.setvariable variable=PushBuildImages;]false"
#      echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
#      echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
#      echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
#    displayName: 'Set variables'
#  - template: templates/_buildTemplate.yml
#    parameters:
#        imageType: full

#- job: Job_BuildImage_Cli
#  displayName: Build and Test Build Cli Image
#  pool:
#    name: AzurePipelines-EO
#    demands:
#      - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
#  timeoutInMinutes: 480
#  steps:
#  - script: |
#      echo "##vso[task.setvariable variable=BuildBuildImages;]true"
#      echo "##vso[task.setvariable variable=TestBuildImages;]true"
#      echo "##vso[task.setvariable variable=PushBuildImages;]false"
#      echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
#      echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
#      echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
#    displayName: 'Set variables'
#  - template: templates/_buildTemplate.yml
#    parameters:
#        imageType: cli

#- job: Job_BuildImage_Buildpack
#  displayName: Build and Test Build Buildpack Image
#  pool:
#    name: AzurePipelines-EO
#    demands:
#      - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
#  timeoutInMinutes: 480
#  steps:
#  - script: |
#      echo "##vso[task.setvariable variable=BuildBuildImages;]true"
#      echo "##vso[task.setvariable variable=TestBuildImages;]true"
#      echo "##vso[task.setvariable variable=PushBuildImages;]false"
#      echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
#      echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
#      echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
#    displayName: 'Set variables'
#  - template: templates/_buildTemplate.yml
#    parameters:
#        imageType: buildpack

- job: Job_RuntimeImages
  displayName: Build and Test Runtime Images
  pool:
    name: AzurePipelines-EO
    demands:
      - ImageOverride -equals AzurePipelinesUbuntu20.04compliant
  timeoutInMinutes: 480
  steps:
  - script: |
      echo "##vso[task.setvariable variable=BuildRuntimeImages;]true"
      echo "##vso[task.setvariable variable=TestRuntimeImages;]true"
      echo "##vso[task.setvariable variable=PushBuildImages;]false"
      echo "##vso[task.setvariable variable=PushRuntimeImages;]false"
      echo "##vso[task.setvariable variable=EmbedBuildContextInImages;]true"
      echo "##vso[task.setvariable variable=RELEASE_TAG_NAME;]$(Build.BuildNumber)"
    displayName: 'Set variables'
  - template: templates/_buildTemplate.yml

trigger: none